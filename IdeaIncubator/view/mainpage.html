<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Idea Incubator - Main</title>
  <!-- Optionally include Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

  <h1>Idea Incubator - Main Page</h1>
  <button id="btnSignOut">Sign Out</button>
  <button id="btnEditProfile">Edit Profile</button>
  <button id="btnUnsubscribe">Unsubscribe</button>

  <hr>

  <!-- Post Idea Form -->
  <h2>Post a New Idea</h2>
  <label>Title: 
    <input type="text" id="idea-title">
  </label><br>
  <label>Content: 
    <textarea id="idea-content" rows="4" cols="50"></textarea>
  </label><br>
  <label>Category:
    <input type="text" id="idea-category">
  </label><br>
  <button id="btnPostIdea">Post Idea</button>

  <hr>

  <h2>All Ideas</h2>
  <div id="ideas-list">Loading ideas...</div>

  <!-- Hidden Edit Profile form (modal or simple) -->
  <div id="profile-modal" style="display:none; border:1px solid black; padding:10px;">
    <h3>Edit Profile</h3>
    <label>New Password:
      <input type="password" id="profile-newpass">
    </label><br>
    <label>New Email:
      <input type="text" id="profile-newemail">
    </label><br>
    <button id="btnSaveProfile">Save Changes</button>
    <button id="btnCancelProfile">Cancel</button>
  </div>

  <!-- A place to show messages -->
  <div id="message" style="color:red;"></div>

<script>
const CONTROLLER = "../controller/controller.php"; // Adjust if needed

// On page load, load ideas
$(document).ready(function(){
  loadIdeas();
});

// 1) Load ideas from server
function loadIdeas(){
  $.ajax({
    url: CONTROLLER,
    method: "POST",
    data: { command: "LoadIdeas" },
    dataType: "json",
    success: function(resp){
      renderIdeas(resp);
    },
    error: function(){
      $("#ideas-list").html("Error loading ideas");
    }
  });
}

// 2) Render the list of ideas, each with a comment section, vote button, etc.
function renderIdeas(ideas){
  let html = "";
  ideas.forEach(function(idea){
    html += `
      <div style="border:1px solid #aaa; margin:10px; padding:10px;">
        <h3>${idea.title}</h3>
        <p>by ${idea.username} - Category: ${idea.category}</p>
        <p>${idea.description}</p>

        <!-- Voting -->
        <button class="btnVote" data-idea-id="${idea.id}" data-value="1">Upvote</button>
        <button class="btnVote" data-idea-id="${idea.id}" data-value="-1">Downvote</button>
        <span id="vote-score-${idea.id}"> (score unknown)</span>
        <br><br>

        <!-- Comments -->
        <button class="btnLoadComments" data-idea-id="${idea.id}">Load Comments</button>
        <div id="comments-${idea.id}" style="margin-left:25px;">
          <!-- comments go here -->
        </div>
        <br>
        <textarea id="comment-text-${idea.id}" rows="2" cols="40" placeholder="Add comment"></textarea>
        <br>
        <button class="btnComment" data-idea-id="${idea.id}">Post Comment</button>
      </div>
    `;
  });

  $("#ideas-list").html(html);

  // Hook up comment buttons
  $(".btnComment").on("click", function(){
    let idea_id = $(this).data("idea-id");
    postComment(idea_id);
  });

  // Hook up "Load Comments" buttons
  $(".btnLoadComments").on("click", function(){
    let idea_id = $(this).data("idea-id");
    loadComments(idea_id);
  });

  // Hook up voting
  $(".btnVote").on("click", function(){
    let idea_id = $(this).data("idea-id");
    let val     = $(this).data("value");
    voteIdea(idea_id, val);
  });
}

// 3) Post a new idea
$("#btnPostIdea").on("click", function(){
  let t   = $("#idea-title").val();
  let c   = $("#idea-content").val();
  let cat = $("#idea-category").val();
  $.ajax({
    url: CONTROLLER,
    method: "POST",
    data: {
      command: "PostIdea",
      title: t,
      description: c,
      category: cat
    },
    dataType: "json",
    success: function(resp){
      if (resp.status==="ok"){
        $("#message").text("Idea posted!");
        // Reload the list
        loadIdeas();
      } else {
        $("#message").text(resp.msg);
      }
    },
    error: function(){
      $("#message").text("Error posting idea.");
    }
  });
});

// 4) Post Comment
function postComment(idea_id){
  let content = $(`#comment-text-${idea_id}`).val();
  $.ajax({
    url: CONTROLLER,
    method: "POST",
    data: {
      command: "PostComment",
      idea_id: idea_id,
      comment_text: content
    },
    dataType: "json",
    success: function(resp){
      if(resp.status==="ok"){
        $(`#comment-text-${idea_id}`).val("");
        loadComments(idea_id);
      } else {
        $("#message").text(resp.msg);
      }
    },
    error: function(){
      $("#message").text("Error posting comment.");
    }
  });
}

// 5) Load comments for a single idea
function loadComments(idea_id){
  $.ajax({
    url: CONTROLLER,
    method: "GET", // you can do GET or POST
    data: {
      command: "LoadComments",
      idea_id: idea_id
    },
    dataType: "json",
    success: function(resp){
      renderComments(idea_id, resp);
    },
    error: function(){
      $(`#comments-${idea_id}`).html("Error loading comments.");
    }
  });
}

function renderComments(idea_id, comments){
  let html = "<ul>";
  comments.forEach(function(c){
    html += `<li><b>${c.username}:</b> ${c.comment_text} <i>(${c.comment_date})</i></li>`;
  });
  html += "</ul>";
  $(`#comments-${idea_id}`).html(html);
}

// 6) Vote on an idea
function voteIdea(idea_id, val){
  $.ajax({
    url: CONTROLLER,
    method: "POST",
    data: {
      command: "Vote",
      idea_id: idea_id,
      vote_value: val
    },
    dataType: "json",
    success: function(resp){
      if (resp.status==="ok"){
        let score = resp.score ?? "N/A";
        $(`#vote-score-${idea_id}`).text(" (score: "+score+")");
      } else {
        $("#message").text(resp.msg);
      }
    },
    error: function(){
      $("#message").text("Error voting on idea.");
    }
  });
}

// 7) Sign Out
$("#btnSignOut").on("click", function(){
  $.ajax({
    url: CONTROLLER,
    method: "POST",
    data: { command: "SignOut" },
    dataType: "json",
    success: function(resp){
      if(resp.status==="ok"){
        window.location.href = "startpage.html";
      } else {
        $("#message").text(resp.msg);
      }
    }
  });
});

// 8) Edit Profile
$("#btnEditProfile").on("click", function(){
  $("#profile-modal").show();
});

$("#btnCancelProfile").on("click", function(){
  $("#profile-modal").hide();
});

$("#btnSaveProfile").on("click", function(){
  let newpass  = $("#profile-newpass").val();
  let newemail = $("#profile-newemail").val();
  $.ajax({
    url: CONTROLLER,
    method: "POST",
    dataType: "json",
    data: {
      command: "UpdateProfile",
      newpass: newpass,
      newemail: newemail
    },
    success: function(resp){
      if(resp.status==="ok"){
        $("#message").text("Profile updated!");
        $("#profile-modal").hide();
      } else {
        $("#message").text(resp.msg);
      }
    }
  });
});

// 9) Unsubscribe
$("#btnUnsubscribe").on("click", function(){
  if(!confirm("Are you sure you want to DELETE your account?")) {
    return;
  }
  $.ajax({
    url: CONTROLLER,
    method: "POST",
    dataType: "json",
    data: {
      command: "Unsubscribe"
    },
    success: function(resp){
      if(resp.status==="ok"){
        alert("Your account has been deleted.");
        window.location.href = "startpage.html";
      } else {
        $("#message").text(resp.msg);
      }
    }
  });
});

// Example button for editing:
// <button class="btnEditIdea" data-idea-id="...">Edit Idea</button>

$(".btnEditIdea").on("click", function(){
    let idea_id = $(this).data("idea-id");
    // perhaps show a modal with current idea data in text fields
    // then on "save", do something like:
  
    $.ajax({
      url: CONTROLLER,
      method: "POST",
      data: {
        command: "EditIdea",
        idea_id: idea_id,
        title:   "New Title",
        content: "New Content",
        category:"New Category"
      },
      dataType: "json",
      success: function(resp) {
        if(resp.status === "ok"){
          // reload the idea list or refresh the single idea
        } else {
          alert(resp.msg);
        }
      }
    });
  });
  
  // Example button in each idea block:
// <button class="btnDeleteIdea" data-idea-id="...">Delete Idea</button>

$(".btnDeleteIdea").on("click", function(){
    if(!confirm("Are you sure you want to delete this idea?")) return;
    let idea_id = $(this).data("idea-id");
    $.ajax({
      url: CONTROLLER,
      method: "POST",
      data: { command:"DeleteIdea", idea_id: idea_id },
      dataType:"json",
      success: function(resp){
        if(resp.status==="ok"){
          alert("Idea deleted");
          // reload idea list
          loadIdeas();
        } else {
          alert(resp.msg);
        }
      }
    });
  });
  
</script>
</body>
</html>
